---
- name: Test port is propagated to systemd socket service
  hosts: all
  vars:
    __sshd_test_backup_files:
      - /etc/ssh/sshd_config
      - /etc/ssh/sshd_config.d/00-ansible_system_role.conf
      - /etc/systemd/system/sshd.service
      - /etc/systemd/system/sshd@.service
      - /etc/systemd/system/sshd.socket
      - /etc/systemd/system/ssh.service
      - /etc/systemd/system/ssh@.service
      - /etc/systemd/system/ssh.socket
    __sshd_test_service_name: sshd
    __sshd_service_list: []
    __sshd_service_inst_list: []
    __sshd_socket_list: []
  tasks:
    - name: Fix the service name on Debian
      ansible.builtin.set_fact:
        __sshd_test_service_name: ssh
      when:
        - ansible_facts['os_family'] == "Debian"

    - name: Backup configuration files
      ansible.builtin.include_tasks: tasks/backup.yml

    - name: Configure sshd with default options and install service files
      ansible.builtin.include_role:
        name: ansible-sshd
      vars:
        sshd_install_service: true
        sshd_config:
          ListenAddress:
            - 1.2.3.4
            - "[::42]"
          Port:
            - 33
            - 3333

    - name: Read the socket file and verify it contains correct ports
      tags: tests::verify
      when:
        - ansible_facts['service_mgr'] == 'systemd' or
          (ansible_facts['os_family'] == 'RedHat' and ansible_facts['distribution_major_version'] == '7')
      block:
        - name: Read the created socket file
          ansible.builtin.slurp:
            src: "/etc/systemd/system/{{ __sshd_test_service_name }}.socket"
          register: socket

        - name: Print the generated socket file
          ansible.builtin.debug:
            msg: "{{ socket.content | b64decode }}"

        - name: Test port is propagated to sshd.socket
          ansible.builtin.assert:
            that:
              - "'ListenStream=1.2.3.4:33' in socket.content | b64decode"
              - "'ListenStream=[::42]:33' in socket.content | b64decode"
              - "'ListenStream=1.2.3.4:3333' in socket.content | b64decode"
              - "'ListenStream=[::42]:3333' in socket.content | b64decode"

    - name: "Restore configuration files"
      ansible.builtin.include_tasks: tasks/restore.yml
